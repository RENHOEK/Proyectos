<!DOCTYPE HTML>
<html>
    <head>
       <title>Cubo</title>
       <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
       <style>
        #control
        {
            float: left;
            margin-left:30px ;
            text-align: justify;
        }

       </style>
       <link rel="stylesheet" href="css/jquery-ui-1.8.17.custom.css">
       <script src="src/jquery-1.7.1.js"></script>
       <script src="src/external/jquery.bgiframe-2.1.2.js"></script>
       <script src="src/ui/jquery.ui.core.js"></script>
       <script src="src/ui/jquery.ui.widget.js"></script>
       <script src="src/ui/jquery.ui.mouse.js"></script>
       <script src="src/ui/jquery.ui.button.js"></script>
       <script src="src/ui/jquery.ui.draggable.js"></script>
       <script src="src/ui/jquery.ui.position.js"></script>
       <script src="src/ui/jquery.ui.resizable.js"></script>
       <script src="src/ui/jquery.ui.dialog.js"></script>
       <script src="src/ui/jquery.ui.slider.js"></script>
       <link rel="stylesheet" href="css/demos.css">
       <script type="text/javascript" src="src/funciones.js"></script>
       <script type="text/javascript" src="src/gl-matrix-min.js"></script>
       <script id="shader-fs" type="x-shader/x-fragment">
                    #ifdef GL_ES
                         precision highp float;
                    #endif
                    varying vec4 vColor;
                    void main(void)
                    {
                        gl_FragColor = vColor;
                    }
       </script>

       <script id="shader-vs" type="x-shader/x-vertex">
                    attribute vec3 aVertexPosition;
                    attribute vec4 aVertexColor;
                    uniform mat4 uMVMatrix;
                    uniform mat4 uPMatrix;
                    varying vec4 vColor;
                    void main(void)
                    {
                        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
                        vColor = aVertexColor;
                    }
       </script>

       <script type="text/javascript">
                    var webgl;
                    var at = new atributosPipeline(mat4.create(),mat4.create());
                    var cubo = new objeto3D([-1.0, -1.0,  1.0, // Cara frontal
                                              1.0, -1.0,  1.0,
                                              1.0,  1.0,  1.0,
                                             -1.0,  1.0,  1.0,
                                             -1.0, -1.0, -1.0,// Cara trasera
                                             -1.0,  1.0, -1.0,
                                              1.0,  1.0, -1.0,
                                              1.0, -1.0, -1.0,
                                             -1.0,  1.0, -1.0,// Cara de arriba
                                             -1.0,  1.0,  1.0,
                                              1.0,  1.0,  1.0,
                                              1.0,  1.0, -1.0,
                                             -1.0, -1.0, -1.0,// cara de abajo
                                              1.0, -1.0, -1.0,
                                              1.0, -1.0,  1.0,
                                             -1.0, -1.0,  1.0,
                                              1.0, -1.0, -1.0,// Cara derecha
                                              1.0,  1.0, -1.0,
                                              1.0,  1.0,  1.0,
                                              1.0, -1.0,  1.0,
                                             -1.0, -1.0, -1.0,// Cara izquierda
                                             -1.0, -1.0,  1.0,
                                             -1.0,  1.0,  1.0,
                                             -1.0,  1.0, -1.0]);
                    colores = [[1.0, 0.0, 0.0, 1.0], // Rojo- Cara frontal
                              [1.0, 1.0, 0.0, 1.0], // Amarillo - Cara trasera
                              [0.0, 1.0, 0.0, 1.0], // Verde - Cara arriba
                              [1.0, 0.5, 0.5, 1.0], // Naranja - Cara abajo
                              [1.0, 0.0, 1.0, 1.0], // Rosa - Cara derecha
                              [0.0, 0.0, 1.0, 1.0]];// Azul - Cara izquierda

                    for (var i in colores)
                    {
                        var colorpuntos = colores[i];
                        for (var j=0; j < 4; j++)
                        {
                           cubo.vectoresColor = cubo.vectoresColor.concat(colorpuntos);
                        }
                    }
                    //2 Triangulos que componen a cda una de las caras del cubo
                    cubo.indicesVertices = [0, 1, 2,      0, 2, 3,    //Componen cara Frontal
                                            4, 5, 6,      4, 6, 7,    // Componen Cara trasera
                                            8, 9, 10,     8, 10, 11,  //Componen cara arriba
                                            12, 13, 14,   12, 14, 15, // Componen cara abajo
                                            16, 17, 18,   16, 18, 19, // Componen cara derecha
                                            20, 21, 22,   20, 22, 23];  // Componen Cara izquierda

                    //Funcion que inicia los shaders
                    function initShaders()
                    {
                        var fragmentShader = getShader(webgl, "shader-fs");
                        var vertexShader = getShader(webgl, "shader-vs");

                        at.ShaderProgram = webgl.createProgram();
                        webgl.attachShader(at.ShaderProgram, vertexShader);
                        webgl.attachShader(at.ShaderProgram, fragmentShader);
                        webgl.linkProgram(at.ShaderProgram);

                        if (!webgl.getProgramParameter(at.ShaderProgram, webgl.LINK_STATUS))
                                alert("No pueden iniciarse los shaders");

                        webgl.useProgram(at.ShaderProgram);
                        at.ShaderProgram.vertexPositionAttribute = webgl.getAttribLocation(at.ShaderProgram, "aVertexPosition");
                        webgl.enableVertexAttribArray(at.ShaderProgram.vertexPositionAttribute);
                        at.ShaderProgram.vertexColorAttribute = webgl.getAttribLocation(at.ShaderProgram, "aVertexColor");
                        webgl.enableVertexAttribArray(at.ShaderProgram.vertexColorAttribute);
                        at.ShaderProgram.pMatrizUniform = webgl.getUniformLocation(at.ShaderProgram, "uPMatrix");
                        at.ShaderProgram.mvMatrizUniform = webgl.getUniformLocation(at.ShaderProgram, "uMVMatrix");
                    }
                    //Funcion que inicia los buffers del objeto en la Tarjeta Grafica
                    function initBuffers()
                    {
                        cubo.bufferVertices=webgl.createBuffer();
                        webgl.bindBuffer(webgl.ARRAY_BUFFER, cubo.bufferVertices);
                        webgl.bufferData(webgl.ARRAY_BUFFER, new Float32Array(cubo.vertices), webgl.STATIC_DRAW);

                        cubo.bufferColor = webgl.createBuffer();
                        webgl.bindBuffer(webgl.ARRAY_BUFFER, cubo.bufferColor);
                        webgl.bufferData(webgl.ARRAY_BUFFER, new Float32Array(cubo.vectoresColor), webgl.STATIC_DRAW)

                        cubo.bufferIndicesVertices = webgl.createBuffer();
                        webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, cubo.bufferIndicesVertices);
                        webgl.bufferData(webgl.ELEMENT_ARRAY_BUFFER, new Uint16Array(cubo.indicesVertices), webgl.STATIC_DRAW);
                    }
                    //Funcion que dibuja sobre el contexto WebGL
                    function dibujarEscena()
                    {
                        webgl.viewport(0, 0, webgl.viewportWidth, webgl.viewportHeight);
                        webgl.clear(webgl.COLOR_BUFFER_BIT | webgl.DEPTH_BUFFER_BIT);
                        if(document.getElementsByName('tiposperspectivas')[0].checked)
                        {
                             mat4.perspective(parseFloat(document.getElementById("slider").value), webgl.viewportWidth / webgl.viewportHeight, 0.1, 100.0, at.pMatriz);
                             document.getElementById('slider').disabled=false;
                        }
                        else
                        {
                             mat4.ortho(-5,5,-5,5,-7,7,at.pMatriz);
                             document.getElementById('slider').disabled=true;
                        }
                        mat4.identity(at.mvMatriz);

                        mvPushMatriz(at);
                        mat4.scale(at.mvMatriz,[checarNumber("EX"), checarNumber("EY"), checarNumber("EZ")]);
                        console.log(at.mvMatriz);
                        mat4.translate(at.mvMatriz, [checarNumber("TX"), checarNumber("TY"), checarNumber("TZ")]);
                        mat4.rotate(at.mvMatriz,grado_radian(rPyramid), [checarBox("rotarX"), checarBox("rotarY"), checarBox("rotarZ")]);
                        webgl.bindBuffer(webgl.ARRAY_BUFFER, cubo.bufferVertices);
                        webgl.vertexAttribPointer(at.ShaderProgram.vertexPositionAttribute, 3, webgl.FLOAT, false, 0, 0);

                        webgl.bindBuffer(webgl.ARRAY_BUFFER, cubo.bufferColor);
                        webgl.vertexAttribPointer(at.ShaderProgram.vertexColorAttribute, 4, webgl.FLOAT, false, 0, 0);
                        webgl.bindBuffer(webgl.ELEMENT_ARRAY_BUFFER, cubo.bufferIndicesVertices);
                        setMatrizUniforms(webgl, at);
                        webgl.drawElements(webgl.TRIANGLES, 36, webgl.UNSIGNED_SHORT, 0);
                        mvPopMatriz(at);
                        webgl.flush();
                    }

                    //Funcion que llama el navegador cuando la pagina esta completamente cargada
                    function webGLStart()
                    {
                        var canvas = document.getElementById("canvas");
                        //document.onkeydown = handleKeyDown;
                        webgl =  contextoWebGL(canvas);
                        if(webgl==null)
                            alert("No puede iniciarse WebGL en este navegador");
                        else
                        {
                            initShaders();
                            initBuffers();
                            webgl.clearColor(1.0, 1.0, 1.0, 1.0);
                            webgl.enable(webgl.DEPTH_TEST);
                            instante();
                        }
                    }

                    var tiempo = 0;
                    var rPyramid=0;
                    function animar()
                    {
                        var tiempoActual = new Date().getTime();
                        if (tiempo != 0)
                        {
                            var tiempotranscurrido = tiempoActual - tiempo;
                            rPyramid += (90 * tiempotranscurrido) / 1000.0;
                        }
                        tiempo = tiempoActual;
                    }
                    function instante()
                    {
                        requestAnimFrame(instante);
                        dibujarEscena();
                        animar();
                    }
       </script>
    </head>
    <body onload="webGLStart();">
      <div style="text-align:center">
          <h1>WebGL</h1>
          <h3>Cubo</h3>

      <div id="control">
      <fieldset >
        <legend id="leyenda">Transformaciones</legend>
        <input id="rotarX" type="checkbox" checked="checked" /> Rotar X<br />
        <input id="rotarY" type="checkbox"  /> Rotar Y<br />
        <input id="rotarZ" type="checkbox"  /> Rotar Z<br />
        <input id="EX"  type="number"  min="1"  max="7"  step="1"  value="1">Escalar X<br />
        <input id="EY"  type="number"  min="1"  max="7"  step="1"  value="1">Escalar Y<br />
        <input id="EZ"  type="number"  min="1"  max="7"  step="1"  value="1">Escalar Z<br />
        <input id="TX" type="number"  min="-7"  max="7"  step="1"  value="0">Transladar X<br />
        <input id="TY" type="number"  min="-7"  max="7"  step="1"  value="0">Transladar Y<br />
        <input id="TZ" type="number"  min="-15"  max="0"  step="1"  value="-7">Transladar Z<br />
      </fieldset>
      <fieldset>
        <legend id="leyenda">Proyecciones</legend>
        <input type="radio" name="tiposperspectivas" checked="checked" />Perspectiva<br />
        <input id="slider" type="range"  min="1"  max="180"  step="1"  value="45">Angulo<br />
        <input type="radio" name="tiposperspectivas" />Ortogonal
      </fieldset>
      </div>
        <canvas id="canvas" style="border-width: 1px;border-style: solid;border-color: black;" width="450" height="450"></canvas>
      </div>
      <div id="dialogmessage"></div>
    </body>
</html>