<!DOCTYPE html>
<html>
      <head>
            <title>WebGL-Piramide 3D</title>
            <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
            <link rel="stylesheet" href="css/jquery-ui-1.8.17.custom.css">
            <script src="src/jquery-1.7.1.js"></script>
            <script src="src/external/jquery.bgiframe-2.1.2.js"></script>
            <script src="src/ui/jquery.ui.core.js"></script>
            <script src="src/ui/jquery.ui.widget.js"></script>
            <script src="src/ui/jquery.ui.mouse.js"></script>
            <script src="src/ui/jquery.ui.button.js"></script>
            <script src="src/ui/jquery.ui.draggable.js"></script>
            <script src="src/ui/jquery.ui.position.js"></script>
            <script src="src/ui/jquery.ui.resizable.js"></script>
            <script src="src/ui/jquery.ui.dialog.js"></script>
            <script src="src/ui/jquery.ui.slider.js"></script>
            <link rel="stylesheet" href="css/demos.css">


            <script type="text/javascript" src="src/funciones.js"></script>
            <script type="text/javascript" src="src/glMatrix-0.9.5.min.js"></script>
            <script>
            	$(function()
                {
            		$( "#slider" ).slider({
            			range: "max",
            			min: 1,
            			max: 180,
            			value: 45,
            			slide: function( event, ui ) {
            				$( "#amount" ).val( ui.value );
            			}
            		});
            		$( "#amount" ).val( $( "#slider" ).slider( "value" ) );
                });
	       </script>
            <script id="shader-fs" type="x-shader/x-fragment">
                    #ifdef GL_ES
						precision highp float;
					#endif

					varying vec2 vTextureCoord;
					uniform sampler2D uSampler;

					void main(void) {
						gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
					}
            </script>

            <script id="shader-vs" type="x-shader/x-vertex">
                    attribute vec3 aVertexPosition;
                    attribute vec2 aTextureCoord;
                    uniform mat4 uMVMatrix;
                    uniform mat4 uPMatrix;
                    varying vec2 vTextureCoord;
					void main(void) {
						gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
						vTextureCoord = aTextureCoord;
					}
            </script>

            <script type="text/javascript">
                    var webgl;
                    var at = new atributosPipeline(mat4.create(),mat4.create());
                    var piramide = new objeto3D([0.0,  1.0,  0.0,// Cara frontal
                                                -1.0, -1.0,  1.0,
                                                 1.0, -1.0,  1.0,
                                                 0.0,  1.0,  0.0,// Cara derecha
                                                 1.0, -1.0,  1.0,
                                                 1.0, -1.0, -1.0,
                                                 0.0,  1.0,  0.0, // Cara trasera
                                                 1.0, -1.0, -1.0,
                                                -1.0, -1.0, -1.0,
                                                 0.0,  1.0,  0.0,// Cara izquierda
                                                -1.0, -1.0, -1.0,
                                                -1.0, -1.0,  1.0]);
                    piramide.textureCoords= [ 0.5, 1.0,// Front face
											  0.0, 0.0,
											  1.0, 0.0,											  
											  
											  0.5, 1.0,// Back face
											  0.0, 0.0,
											  1.0, 0.0,
											  
                                              0.5, 1.0,// Right face
											  0.0, 0.0,
											  1.0, 0.0,
											  
											  0.5, 1.0,// Left face
											  0.0, 0.0,
											  1.0, 0.0];
                    
					function handleLoadedTexture(texture) {
						webgl.bindTexture(webgl.TEXTURE_2D, texture);
						webgl.pixelStorei(webgl.UNPACK_FLIP_Y_WEBGL, true);
						webgl.texImage2D(webgl.TEXTURE_2D, 0, webgl.RGBA, webgl.RGBA, webgl.UNSIGNED_BYTE, texture.image);
						webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_MAG_FILTER, webgl.NEAREST);
						webgl.texParameteri(webgl.TEXTURE_2D, webgl.TEXTURE_MIN_FILTER, webgl.NEAREST);
						webgl.bindTexture(webgl.TEXTURE_2D, null);
					}


					var neheTexture;

					function initTexture() {
						neheTexture = webgl.createTexture();
						neheTexture.image = new Image();
						neheTexture.image.onload = function () {
							handleLoadedTexture(neheTexture)
						}

						neheTexture.image.src = "img/p.jpg";
						console.log(neheTexture.image);
					}
					//Funcion que inicia los shaders
                    function initShaders()
                    {
                        var fragmentShader = getShader(webgl, "shader-fs");
                        var vertexShader = getShader(webgl, "shader-vs");

                        at.ShaderProgram = webgl.createProgram();
                        webgl.attachShader(at.ShaderProgram, vertexShader);
                        webgl.attachShader(at.ShaderProgram, fragmentShader);
                        webgl.linkProgram(at.ShaderProgram);

                        if (!webgl.getProgramParameter(at.ShaderProgram, webgl.LINK_STATUS))
                                alert("No pueden iniciarse los shaders");

                        webgl.useProgram(at.ShaderProgram);
                        at.ShaderProgram.vertexPositionAttribute = webgl.getAttribLocation(at.ShaderProgram, "aVertexPosition");
                        webgl.enableVertexAttribArray(at.ShaderProgram.vertexPositionAttribute);
						
                        at.ShaderProgram.textureCoordAttribute = webgl.getAttribLocation(at.ShaderProgram, "aTextureCoord");
                        webgl.enableVertexAttribArray(at.ShaderProgram.textureCoordAttribute);
						
                        at.ShaderProgram.pMatrizUniform = webgl.getUniformLocation(at.ShaderProgram, "uPMatrix");
                        at.ShaderProgram.mvMatrizUniform = webgl.getUniformLocation(at.ShaderProgram, "uMVMatrix");
						at.ShaderProgram.samplerUniform = webgl.getUniformLocation(at.ShaderProgram, "uSampler");
                    }
                    //Funcion que inicia los buffers del objeto en la Tarjeta Grafica
                    function initBuffers()
                    {
                        piramide.bufferVertices=webgl.createBuffer();
                        webgl.bindBuffer(webgl.ARRAY_BUFFER, piramide.bufferVertices);
                        webgl.bufferData(webgl.ARRAY_BUFFER, new Float32Array(piramide.vertices), webgl.STATIC_DRAW);

                        piramide.textureCoordsBuffer = webgl.createBuffer();
                        webgl.bindBuffer(webgl.ARRAY_BUFFER, piramide.textureCoordsBuffer);
                        webgl.bufferData(webgl.ARRAY_BUFFER, new Float32Array(piramide.textureCoords), webgl.STATIC_DRAW);
                    }
                    //Funcion que dibuja sobre el contexto WebGL
                    function dibujarEscena()
                    {   //definimos el viweport
                        var te= parseFloat(document.getElementById("amount").value);
                        webgl.viewport(0, 0, webgl.viewportWidth, webgl.viewportHeight);
                        webgl.clear(webgl.COLOR_BUFFER_BIT | webgl.DEPTH_BUFFER_BIT);
                        mat4.perspective(te, webgl.viewportWidth / webgl.viewportHeight, 0.1, 100.0, at.pMatriz);
                        mat4.identity(at.mvMatriz);
                        mat4.translate(at.mvMatriz, [0.0, 0.0, -7.0]);

                        mvPushMatriz(at);
                          mat4.rotate(at.mvMatriz,grado_radian(rPyramid), [0, 1, 0]);
                          webgl.bindBuffer(webgl.ARRAY_BUFFER, piramide.bufferVertices);
                          webgl.vertexAttribPointer(at.ShaderProgram.vertexPositionAttribute, 3, webgl.FLOAT, false, 0, 0);

                          webgl.bindBuffer(webgl.ARRAY_BUFFER, piramide.textureCoordsBuffer);
                          webgl.vertexAttribPointer(at.ShaderProgram.textureCoordAttribute, 2, webgl.FLOAT, false, 0, 0);
                          
                          webgl.activeTexture(webgl.TEXTURE0);
                          webgl.bindTexture(webgl.TEXTURE_2D, neheTexture);
                          webgl.uniform1i(at.ShaderProgram.samplerUniform, 0);
                          
						  setMatrizUniforms(webgl, at);
                          webgl.drawArrays(webgl.TRIANGLES, 0, piramide.noElementos);
						  
                        mvPopMatriz(at);
                        webgl.flush();
                    }

                    //Funcion que llama el navegador cuando la pagina esta completamente cargada
                    function webGLStart()
                    {
                        var canvas = document.getElementById("canvas");
                        //document.onkeydown = handleKeyDown;
                        webgl =  contextoWebGL(canvas);
                        if(webgl==null)
                            alert("No puede iniciarse WebGL en este navegador");
                        else
                        {
                            initShaders();
                            initBuffers();
							initTexture();
                            webgl.clearColor(0.0, 0.0, 0.0, 1.0);
                            webgl.enable(webgl.DEPTH_TEST);
                            instante();
                        }
                    }
                   
                    var tiempo = 0;
                    var rPyramid=0;
                    function animar()
                    {
                        var tiempoActual = new Date().getTime();
                        if (tiempo != 0)
                        {
                            var tiempotranscurrido = tiempoActual - tiempo;
                            rPyramid += (90 * tiempotranscurrido) / 1000.0;
                        }
                        tiempo = tiempoActual;
                    }
                    function instante()
                    {
                        requestAnimFrame(instante);
                        dibujarEscena();
                        animar();
                    }

            </script>

        </head>
        <body onload="webGLStart();">
            <div style="text-align:center">
                <h1>WebGL</h1>
                <h3>Piramide</h3>
                <canvas id="canvas" style="display:inline;border-width: 1px;border-style: solid;border-color: black;" width="450" height="450"></canvas>
            </div>
            <div class="demo">

             <div>
                <p style="text-align: center">
              	<label for="amount">Angulo Perspectiva:</label>
              	<input type="text" id="amount" size=3 value="45.0"   style="border:0; color:#f6931f; font-weight:bold;" />
              </p>
             </div>
             <div id="slider"  style="margin-left:350px; width:300px;"></div>
             <div id="dialogmessage"></div>

            </div>

        </body>
</html>
